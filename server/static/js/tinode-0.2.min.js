var Tinode=(function(){var a={PROTOVERSION:"0",VERSION:"0.2",TOPIC_ME:"!me",TOPIC_PRES:"!pres",TOPIC_P2P:"!usr:"};var b=false;a.init=function(c,e){a.apikey=c;a.token=null;a.tokenExpires=null;a.myUID=null;var d=document.createElement("a");d.href=e;d.pathname=d.pathname||"/";d.pathname+="v"+Tinode.PROTOVERSION;a.baseUrl=d.protocol+"//"+d.host+d.pathname+d.search;a.contCache={}};a.xdreq=function(){var c=null;if("withCredentials" in new XMLHttpRequest()){c=new XMLHttpRequest()}else{if(typeof XDomainRequest!=="undefined"){c=new XDomainRequest()}else{throw new Error("browser not supported")}}return c};a.getCurrentUserID=function(){return a.myUID};a.getTokenExpiration=function(){return a.tokenExpires};a.getToken=function(){return a.token};a._jsonHelper=function(c,d){if(d==null||d.length===0){return undefined}return d};a.logToConsole=function(c){b=c};a._logger=function(c){if(b){console.log(c)}};return a})();Tinode.streaming=(function(){var k={};var d=null;var h=null;var c=null;var e=null;var l=null;var i=0;k.init=function(m){k.messageId=0;k.onConnect=null;k.onLogin=null;k.onCtrlMessage=null;k.onDataMessage=null;k.onMessage=null;k.onDisconnect=null;k.onPresenceChange=null;k.Echo=false;if(m==="lp"){f()}else{if(m==="ws"){g()}else{if(!window.WebSocket){f()}else{g()}}}};function b(o,n){var m=null;switch(o){case"login":return{login:{scheme:null,secret:null,id:"login",expireIn:null}};case"sub":m={sub:{topic:n,params:{}}};if(k.messageId!=0){m.sub.id=""+k.messageId++}return m;case"unsub":m={unsub:{topic:n}};if(k.messageId!=0){m.unsub.id=""+k.messageId++}return m;case"pub":m={pub:{topic:n,params:{},content:{}}};if(k.messageId!=0){m.pub.id=""+k.messageId++}return m;default:throw new Error("unknown packet type requested: "+o)}}function j(m,n){var o=document.createElement("a");o.href=m;o.pathname+="/channels";if(n==="http"||n==="https"){o.pathname+="/lp"}o.search=(o.search?o.search:"?")+"apikey="+Tinode.apikey;return n+"://"+o.host+o.pathname+o.search}function a(q){if(!q){return}i++;Tinode._logger("in: "+q);if(k.onMessage){k.onMessage(q)}var o=JSON.parse(q);if(!o){Tinode._logger("ERROR: failed to parse data '"+q+"'")}else{if(o.ctrl!=null){if(i==1){if(k.onConnect){k.onConnect(o.ctrl.code,o.ctrl.text,o.ctrl.params)}}else{if(o.ctrl.id=="login"){if(o.ctrl.code==200){Tinode.token=o.ctrl.params.token;Tinode.myUID=o.ctrl.params.uid;Tinode.tokenExpires=new Date(o.ctrl.params.expires)}if(k.onLogin){k.onLogin(o.ctrl.code,o.ctrl.text)}}}if(k.onCtrlMessage){k.onCtrlMessage(o.ctrl)}}else{if(o.data!=null){if(o.data.topic==="!pres"){for(var n in o.data.content){var p=o.data.content[n];var m=Tinode.contCache[p.who];if(m){m.online=p.online;m.status=p.status;Tinode.contCache[p.who]=m}else{m=p}if(k.onPresenceChange){k.onPresenceChange(p.who,m)}}}if(k.onDataMessage){k.onDataMessage(o.data)}}else{Tinode._logger("unknown packet received")}}}}k.Login=function(o,n){var m=b("login");m.login.scheme="basic";m.login.secret=o+":"+n;m.login.expireIn="24h";k._send(m);return m.login.id};k.Subscribe=function(n,o){var m=b("sub",n);m.sub.params=o;k._send(m);return m.sub.id};k.Unsubscribe=function(n){var m=b("unsub",n);k._send(m);return m.unsub.id};k.Publish=function(n,p,o){var m=b("pub",n);if(p){m.pub.params=p}if(k.Echo){m.pub.params.echo=true}m.pub.content=o;k._send(m);return m.pub.id};function g(){d=null;k.Connect=function(n){h=j(Tinode.baseUrl,n?"wss":"ws");Tinode._logger("Connecting to: "+h);var m=new WebSocket(h);m.onopen=function(o){if(k.onSocketOpen){k.onSocketOpen()}};m.onclose=function(o){d=null;i=0;if(k.onDisconnect){k.onDisconnect()}};m.onmessage=function(o){a(o.data)};d=m};k.Disconnect=function(){if(d){d.close()}};k._send=function(m){var n=JSON.stringify(m,Tinode._jsonHelper);Tinode._logger("out: "+n);if(d.readyState==d.OPEN){d.send(n)}else{throw new Error("websocket not connected")}}}function f(){c=null;e=null;l=null;function m(o){var p=Tinode.xdreq();p.open("POST",o,true);p.onreadystatechange=function(q){if(p.readyState==4&&p.status>=400){Tinode._logger("ERROR: lp sender failed, "+p.status)}};return p}function n(o){var p=Tinode.xdreq();p.open("GET",o,true);p.onreadystatechange=function(r){if(p.readyState==4){if(p.status==201){var q=JSON.parse(p.responseText);var s=p.responseText;c=h+"&sid="+q.ctrl.params.sid;p=n(c,true);p.send(null);a(s)}else{if(p.status==200){a(p.responseText);p=n(c);p.send(null)}else{a(p.responseText);if(k.onDisconnect){k.onDisconnect()}}}}};return p}k._send=function(o){var p=JSON.stringify(o,Tinode._jsonHelper);Tinode._logger("out: "+p);l=m(c);if(l.readyState==1){l.send(p)}else{throw new Error("long poller failed to connect")}};k.Connect=function(o){h=j(Tinode.baseUrl,o?"https":"http");e=n(h);e.send(null)};k.Disconnect=function(){if(l){l.abort();l=null}if(e){e.abort();e=null}if(k.onDisconnect){k.onDisconnect()}}}k.wantAkn=function(m){if(m){k.messageId=Math.floor((Math.random()*16777215)+16777215)}else{k.messageId=0}};k.setEcho=function(m){k.Echo=m};return k})();Tinode.rest=(function(){var b={};function a(c,d,e){var f=document.createElement("a");f.href=c;f.search=(f.search?f.search:"?")+"apikey="+Tinode.apikey+"&token="+Tinode.token;if(d){f.search+="&_q="+JSON.stringify(d)}return(e?"https":"http")+"://"+f.host+f.pathname+f.search}b.init=function(){};b.Login=function(d,c,h){var e=a(Tinode.baseUrl+"/login",false);var g="username="+d+"&secret="+c;var f=Tinode.xdreq();f.open("POST",e,true);f.setRequestHeader("Content-type","application/x-www-form-urlencoded");f.setRequestHeader("Content-length",g.length);f.onreadystatechange=function(i){if(f.readyState==4){h(f.status,JSON.parse(f.responseText))}};f.send(g)};b.request=function(){return{_url:Tinode.baseUrl,_q:null,addKind:function(c){this._url+="/"+c;return this},addObjectId:function(c){this._url+="/:"+c;return this},setSearchQuery:function(c){this._q=c;return this},addSearchTerm:function(c,d){if(!this._q){this._q={type:"match",match:[]}}this._q.index=c;this._q.match.push(d);return this},build:function(c){return a(this._url,this._q,c)}}};b.Get=function(e,f){var c=e.build(false);var d=Tinode.xdreq();d.open("GET",c,true);d.onreadystatechange=function(g){if(d.readyState==4){f(d.status,JSON.parse(d.responseText))}};d.send(null)};b.Update=function(f,d,g){var c=f.build(false);var e=Tinode.xdreq();e.open("PUT",c,true);e.onreadystatechange=function(h){if(e.readyState==4){g(e.status,JSON.parse(e.responseText))}};e.send(JSON.stringify(d))};b.Create=function(f,d,g){var c=f.build(false);var e=Tinode.xdreq();e.open("POST",c,true);e.onreadystatechange=function(h){if(e.readyState==4){g(e.status,JSON.parse(e.responseText))}};e.send(JSON.stringify(d))};b.Delete=function(e,g,f){var c=e.build(false);var d=this.xdreq();d.open("DELETE",c,true);d.onreadystatechange=function(h){if(d.readyState==4){f(d.status,JSON.parse(d.responseText))}};d.send(null)};return b})();Tinode.contacts=(function(){var a={};var b=Tinode.rest;a.init=function(){};a.Load=function(d){var c=b.request();c=c.addKind("users").addObjectId(Tinode.getCurrentUserID()).addKind("contacts");b.Get(c,function(h,f){var g=0;if(h>=400){ctrl_message(f)}else{for(var e in f){contact=f[e];Tinode.contCache[contact.contactId]=contact;g++}}d(g)})};a.Create=function(c,e){var d=b.request();d=d.addKind("users").addObjectId(Tinode.getCurrentUserID()).addKind("contacts");b.Create(d,c,e)};a.Update=function(d,c,f){var e=b.request();e=e.addKind("users").addObjectId(Tinode.getCurrentUserID()).addKind("contacts").addObjectId(d);b.Update(e,c,f)};a.get=function(c){return Tinode.contCache[c]};a.iterate=function(d){for(var c in Tinode.contCache){d(Tinode.contCache[c])}};a.getCount=function(){var c=0;if(Tinode.contCache){c=Object.keys(Tinode.contCache).length}return c};a.clear=function(){Tinode.contCache.clear()};return a})();Tinode.messages=(function(){var b={};var a=Tinode.rest;b.init=function(){};b.Load=function(d,c,f,g){var e=a.request();e=e.addKind("messages").setSearchQuery({type:"match",index:"topic",match:[d],limit:c,offset:f});a.Get(e,g)};return b})();